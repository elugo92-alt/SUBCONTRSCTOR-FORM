<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subcontractor Information Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAcV7nYWJfpWQIxvwZj7dlMq3DHjSd3STw",
            authDomain: "subcontractor-form-85b4d.firebaseapp.com",
            projectId: "subcontractor-form-85b4d",
            storageBucket: "subcontractor-form-85b4d.firebasestorage.app",
            messagingSenderId: "522983618124",
            appId: "1:522983618124:web:9d9dfc7ac2b7ea56b226e9",
            measurementId: "G-NR9K8DYP1K"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Lucide icons as SVG components
        const Users = () => (
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Mail = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
            </svg>
        );

        const Phone = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
        );

        const Plus = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Trash2 = ({ className }) => (
            <svg className={className} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        function SubcontractorForm() {
            const [companyName, setCompanyName] = useState('');
            const [workers, setWorkers] = useState([
                { id: Date.now(), name: '', email: '', phone: '' }
            ]);
            const [submissions, setSubmissions] = useState([]);
            const [showSuccess, setShowSuccess] = useState(false);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);

            useEffect(() => {
                loadSubmissions();
                
                // Real-time listener for updates
                const unsubscribe = db.collection('submissions').onSnapshot((snapshot) => {
                    const subs = [];
                    snapshot.forEach((doc) => {
                        subs.push({ id: doc.id, ...doc.data() });
                    });
                    subs.sort((a, b) => b.timestamp - a.timestamp);
                    setSubmissions(subs);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const loadSubmissions = async () => {
                try {
                    const snapshot = await db.collection('submissions').orderBy('timestamp', 'desc').get();
                    const subs = [];
                    snapshot.forEach((doc) => {
                        subs.push({ id: doc.id, ...doc.data() });
                    });
                    setSubmissions(subs);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading submissions:', error);
                    setLoading(false);
                }
            };

            const addWorker = () => {
                setWorkers([...workers, { id: Date.now(), name: '', email: '', phone: '' }]);
            };

            const removeWorker = (id) => {
                if (workers.length > 1) {
                    setWorkers(workers.filter(w => w.id !== id));
                }
            };

            const updateWorker = (id, field, value) => {
                setWorkers(workers.map(w => 
                    w.id === id ? { ...w, [field]: value } : w
                ));
            };

            const handleSubmit = async () => {
                if (!companyName.trim()) {
                    alert('Please enter a company/subcontractor name');
                    return;
                }

                const invalidWorkers = workers.filter(w => !w.name || !w.email || !w.phone);
                if (invalidWorkers.length > 0) {
                    alert('Please fill in all fields for each worker');
                    return;
                }

                setSubmitting(true);
                
                try {
                    await db.collection('submissions').add({
                        companyName,
                        workers: workers.map(w => ({ name: w.name, email: w.email, phone: w.phone })),
                        submittedAt: new Date().toLocaleString(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    setCompanyName('');
                    setWorkers([{ id: Date.now(), name: '', email: '', phone: '' }]);
                    setShowSuccess(true);
                    setTimeout(() => setShowSuccess(false), 3000);
                } catch (error) {
                    console.error('Error submitting:', error);
                    alert('Error submitting form. Please try again.');
                } finally {
                    setSubmitting(false);
                }
            };

            const handleDelete = async (id) => {
                if (confirm('Are you sure you want to delete this submission?')) {
                    try {
                        await db.collection('submissions').doc(id).delete();
                    } catch (error) {
                        console.error('Error deleting:', error);
                        alert('Error deleting submission. Please try again.');
                    }
                }
            };

            const handleExport = () => {
                const rows = [['Company/Subcontractor', 'Worker Name', 'Email', 'Phone', 'Submitted At']];
                
                submissions.forEach(sub => {
                    sub.workers.forEach(worker => {
                        rows.push([sub.companyName, worker.name, worker.email, worker.phone, sub.submittedAt]);
                    });
                });

                const csv = rows.map(row => row.join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `subcontractors_${Date.now()}.csv`;
                a.click();
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center gap-3 mb-6">
                                <Users />
                                <h1 className="text-3xl font-bold text-gray-800">Subcontractor Information</h1>
                            </div>

                            <div className="space-y-6 mb-8">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Company/Subcontractor Name *
                                    </label>
                                    <input
                                        type="text"
                                        value={companyName}
                                        onChange={(e) => setCompanyName(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="ABC Construction LLC"
                                    />
                                </div>

                                <div className="border-t pt-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-800">Workers</h3>
                                        <button
                                            onClick={addWorker}
                                            className="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200 transition-colors"
                                        >
                                            <Plus className="w-4 h-4" />
                                            Add Worker
                                        </button>
                                    </div>

                                    {workers.map((worker, index) => (
                                        <div key={worker.id} className="bg-gray-50 rounded-lg p-4 mb-4">
                                            <div className="flex justify-between items-center mb-3">
                                                <span className="font-medium text-gray-700">Worker {index + 1}</span>
                                                {workers.length > 1 && (
                                                    <button
                                                        onClick={() => removeWorker(worker.id)}
                                                        className="text-red-600 hover:text-red-800"
                                                    >
                                                        <X className="w-5 h-5" />
                                                    </button>
                                                )}
                                            </div>

                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 mb-1">
                                                        Full Name *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={worker.name}
                                                        onChange={(e) => updateWorker(worker.id, 'name', e.target.value)}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                        placeholder="John Smith"
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 mb-1">
                                                        Email Address *
                                                    </label>
                                                    <div className="relative">
                                                        <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                                                        <input
                                                            type="email"
                                                            value={worker.email}
                                                            onChange={(e) => updateWorker(worker.id, 'email', e.target.value)}
                                                            className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                            placeholder="john@example.com"
                                                        />
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 mb-1">
                                                        Phone Number *
                                                    </label>
                                                    <div className="relative">
                                                        <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                                                        <input
                                                            type="tel"
                                                            value={worker.phone}
                                                            onChange={(e) => updateWorker(worker.id, 'phone', e.target.value)}
                                                            className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                            placeholder="(555) 123-4567"
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <button
                                    onClick={handleSubmit}
                                    disabled={submitting}
                                    className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                                >
                                    {submitting ? 'Submitting...' : 'Submit All Information'}
                                </button>
                            </div>

                            {showSuccess && (
                                <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                                    Information submitted successfully!
                                </div>
                            )}
                        </div>

                        {loading ? (
                            <div className="bg-white rounded-lg shadow-lg p-6 text-center">
                                <div className="inline-block animate-spin">
                                    <RefreshCw className="w-8 h-8 text-indigo-600" />
                                </div>
                                <p className="mt-2 text-gray-600">Loading submissions...</p>
                            </div>
                        ) : submissions.length > 0 ? (
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800">
                                        Submissions ({submissions.reduce((acc, sub) => acc + sub.workers.length, 0)} workers from {submissions.length} companies)
                                    </h2>
                                    <button
                                        onClick={handleExport}
                                        className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                                    >
                                        <Download className="w-4 h-4" />
                                        Export CSV
                                    </button>
                                </div>

                                <div className="space-y-6">
                                    {submissions.map((sub) => (
                                        <div key={sub.id} className="border rounded-lg p-4">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="text-lg font-semibold text-gray-800">{sub.companyName}</h3>
                                                    <p className="text-sm text-gray-500">Submitted: {sub.submittedAt}</p>
                                                    <p className="text-sm text-gray-500">{sub.workers.length} worker(s)</p>
                                                </div>
                                                <button
                                                    onClick={() => handleDelete(sub.id)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    <Trash2 className="w-5 h-5" />
                                                </button>
                                            </div>

                                            <div className="overflow-x-auto">
                                                <table className="w-full">
                                                    <thead>
                                                        <tr className="bg-gray-50">
                                                            <th className="px-3 py-2 text-left text-xs font-semibold text-gray-700">Name</th>
                                                            <th className="px-3 py-2 text-left text-xs font-semibold text-gray-700">Email</th>
                                                            <th className="px-3 py-2 text-left text-xs font-semibold text-gray-700">Phone</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {sub.workers.map((worker, idx) => (
                                                            <tr key={idx} className="border-t">
                                                                <td className="px-3 py-2 text-sm text-gray-800">{worker.name}</td>
                                                                <td className="px-3 py-2 text-sm text-gray-600">{worker.email}</td>
                                                                <td className="px-3 py-2 text-sm text-gray-600">{worker.phone}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white rounded-lg shadow-lg p-6 text-center text-gray-500">
                                No submissions yet. Share this link with your subcontractors to start collecting information.
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<SubcontractorForm />, document.getElementById('root'));
    </script>
</body>
</html>
